<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Health Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg1: #f0f4f8;
  --bg2: #d9e4ec;
      --primary: #3498db;
 --primary-dark: #2980b9;
      --success: #27ae60;
      --success-dark: #1e8449;
 --warning: #e67e22;
      --warning-dark: #ca6f1e;
 --danger: #c0392b;
  --danger-dark: #a93226;
  --text: #2c3e50;
--muted: #666;
      --high: #f8d7da;
    }
    * { box-sizing: border-box; }
    body {
 font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      margin: 0;
      padding: 20px;
  color: var(--text);
    }
    h1 { text-align: center; margin: 0 0 8px; }
    .sub { text-align: center; color: var(--muted); margin-bottom: 20px; }
    .card {
      background: #fff;
      border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
 padding: 16px;
      margin: 0 auto 16px;
      max-width: 1000px;
    }
    form {
      display: grid;
  grid-template-columns: 140px 1fr 1fr 1fr 2fr auto;
  gap: 10px;
    }
    @media (max-width: 900px) {
      form { grid-template-columns: 1fr 1fr; }
  form button { grid-column: 1 / -1; }
  #notes { grid-column: 1 / -1; }
    }
    input, textarea {
      padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
      font-size: 14px;
      width: 100%;
    }
    textarea { resize: vertical; min-height: 38px; }
    button {
      padding: 10px 16px;
      border: none;
  border-radius: 6px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      transition: background 0.2s, transform 0.02s;
    }
    button:hover { background: var(--primary-dark); }
    button:active { transform: translateY(1px); }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .export-btn { background: var(--success); }
    .export-btn:hover { background: var(--success-dark); }
    .import-label {
 background: var(--warning);
color: white;
  padding: 10px 16px;
      border-radius: 6px;
cursor: pointer;
 display: inline-flex;
      align-items: center;
  font-size: 14px;
font-family: inherit;
    }
.import-label:hover { background: var(--warning-dark); }
    .danger { background: var(--danger); }
    .danger:hover { background: var(--danger-dark); }
    .inline-note { color: var(--muted); font-size: 12px; }
    table {
width: 100%;
  border-collapse: collapse;
 margin-top: 10px;
  background: white;
border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
  text-align: left;
      border-bottom: 1px solid #eee;
 font-size: 14px;
      vertical-align: top;
    }
    th {
      background: var(--primary);
      color: white;
      position: sticky;
 top: 0;
 z-index: 1;
    }
    tr:nth-child(even) { background: #fafafa; }
    .cell-center { text-align: center; }
.row-high { background-color: var(--high) !important; }
    .chip {
  display: inline-block;
  padding: 2px 8px;
border-radius: 12px;
      font-size: 12px;
      margin-right: 6px;
      color: #fff;
    }
    .chip-high { background: #e74c3c; }
    .chip-normal { background: #2ecc71; }
    .table-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
margin-top: 12px;
    }
    canvas {
      margin-top: 10px;
      background: white;
      border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 10px;
    }
    /* Default height for desktop */
    #healthChart {
  height: 420px !important;
    }
    /* Taller height only on mobile devices in portrait mode */
    @media (max-width: 600px) and (orientation: portrait) {
  #healthChart {
  height: 300px !important;
      }
    }
    .footer-note {
 text-align: center;
  color: var(--muted);
  font-size: 12px;
      margin-top: 12px;
    }
    .week-nav {
      display: flex;
 align-items: center;
      justify-content: center;
 gap: 20px;
    }
    .chart-controls {
      display: flex;
  justify-content: center;
  gap: 20px;
 margin-bottom: 16px;
    }
    .chart-radio {
  display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 16px;
  background: var(--bg1);
      transition: background 0.2s;
    }
    .chart-radio:hover {
      background: var(--bg2);
    }
  </style>
</head>
<body>

  <div class="card">
    <form id="entryForm" autocomplete="off">
 <input type="date" id="date" required />
      <input type="number" id="systolic" placeholder="Systolic" min="50" max="250" required />
      <input type="number" id="diastolic" placeholder="Diastolic" min="30" max="200" required />
  <input type="number" id="heartrate" placeholder="Heart rate" min="20" max="240" required />
 <textarea id="notes" placeholder="Notes (optional)"></textarea>
 <button type="submit">Add entry</button>
    </form>
    <div class="table-actions">
      <div class="btn-row">
    <button class="export-btn" id="exportBtn">Export JSON</button>
    <label class="import-label">
    Import JSON
     <input type="file" id="importFile" accept="application/json" style="display:none;" />
   </label>
   <button class="danger" id="clearBtn" title="Clear all data in this browser">Clear all</button>
</div>
      <div class="inline-note">High thresholds: systolic ? 140, diastolic ? 90, heart rate ? 100.</div>
    </div>
  </div>

  <div class="card">
    <table id="dataTable">
  <thead>
    <tr>
      <th>Date</th>
    <th class="cell-center">Systolic</th>
      <th class="cell-center">Diastolic</th>
    <th class="cell-center">Heart rate</th>
      <th>Notes</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
    <div class="footer-note">Duplicate dates overwrite the previous record. Click delete to remove an entry.</div>
  </div>

    <div class="card">
    <div class="week-nav">
      <button id="prevWeek">? Previous Week</button>
 <button id="nextWeek">Next Week ?</button>
    </div>
  </div>  <div class="card">
    <div class="chart-controls">
      <label class="chart-radio">
  <input type="radio" name="chartRange" value="month" checked>
  Current Month
      </label>
 <label class="chart-radio">
        <input type="radio" name="chartRange" value="all">
   All Time
 </label>
    </div>
    <canvas id="healthChart" height="120"></canvas>
    <div class="footer-note">Chart shows systolic, diastolic, and heart rate trends over time.</div>
  </div>

  <script>
    const STORAGE_KEY = 'healthData';

    const form = document.getElementById('entryForm');
    const dateEl = document.getElementById('date');
    const systolicEl = document.getElementById('systolic');
    const diastolicEl = document.getElementById('diastolic');
    const heartrateEl = document.getElementById('heartrate');
    const notesEl = document.getElementById('notes');

    const tableBody = document.querySelector('#dataTable tbody');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const clearBtn = document.getElementById('clearBtn');
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const weekDisplayEl = document.getElementById('weekDisplay');
    const chartRangeInputs = document.querySelectorAll('input[name="chartRange"]');

    let currentWeekStart = new Date();
    currentWeekStart.setHours(0, 0, 0, 0);
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay()); // Set to Sunday

    let chartRangeMode = 'month'; // Default to monthly view

function getWeekRange(date) {
      const start = new Date(date);
      const end = new Date(date);
      end.setDate(end.getDate() + 6); // Saturday
      return { start, end };
    }

    const chartCtx = document.getElementById('healthChart').getContext('2d');

    let entries = safeParse(localStorage.getItem(STORAGE_KEY)) || [];

    const thresholds = { systolic: 140, diastolic: 90, heartrate: 100 };

    function safeParse(json) {
try { return JSON.parse(json); } catch { return null; }
    }
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }
    function sortByDateAsc(a, b) {
      return new Date(a.date).getTime() - new Date(b.date).getTime();
    }
    function isValidEntry(e) {
      if (!e.date || e.systolic === '' || e.diastolic === '' || e.heartrate === '') return false;
      const s = Number(e.systolic), d = Number(e.diastolic), hr = Number(e.heartrate);
  if (Number.isNaN(s) || Number.isNaN(d) || Number.isNaN(hr)) return false;
      if (s < 50 || s > 250 || d < 30 || d > 200 || hr < 20 || hr > 240) return false;
 return true;
    }
function isHigh(e) {
      return Number(e.systolic) >= thresholds.systolic ||
         Number(e.diastolic) >= thresholds.diastolic ||
    Number(e.heartrate) >= thresholds.heartrate;
    }

    function renderTable() {
 entries.sort(sortByDateAsc);
      tableBody.innerHTML = '';
  const { start, end } = getWeekRange(currentWeekStart);
  
      const weekEntries = entries.filter(e => {
    const date = new Date(e.date);
  // Reset time parts to ensure accurate date comparison
    date.setHours(0, 0, 0, 0);
   start.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);
    // Compare using timestamps for accurate day comparison
   return date.getTime() >= start.getTime() && date.getTime() <= end.getTime();
  });
      
 for (const e of weekEntries) {
    const tr = document.createElement('tr');
   if (isHigh(e)) tr.classList.add('row-high');
    tr.innerHTML = `
    <td>${e.date}</td>
    <td class="cell-center">${e.systolic}</td>
     <td class="cell-center">${e.diastolic}</td>
 <td class="cell-center">${e.heartrate}</td>
      <td>${(e.notes || '').replace(/</g, '&lt;')}</td>
    `;
        tableBody.appendChild(tr);
      }
      document.querySelectorAll('.row-del').forEach(btn => {
    btn.addEventListener('click', (ev) => {
     const i = Number(ev.currentTarget.getAttribute('data-idx'));
      entries.splice(i, 1);
     save(); renderTable(); renderChart(); renderWeekly();
        });
 });
}

    function getISOWeek(d) {
const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
 const dayNum = date.getUTCDay() || 7;
 date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      return { year: date.getUTCFullYear(), week: weekNo };
    }

    function renderWeekly() {
      weeklyBody.innerHTML = '';
      if (entries.length === 0) return;
      const groups = new Map();
      for (const e of entries) {
    const d = new Date(e.date);
  if (isNaN(d)) continue;
        const { year, week } = getISOWeek(d);
    const key = `${year}-W${String(week).padStart(2,'0')}`;
   if (!groups.has(key)) groups.set(key, []);
  groups.get(key).push(e);
  }
      const keys = [...groups.keys()].sort();
for (const key of keys) {
    const arr = groups.get(key);
        const avgS = (arr.reduce((s,x)=> s + Number(x.systolic), 0) / arr.length).toFixed(1);
        const avgD = (arr.reduce((s,x)=> s + Number(x.diastolic), 0) / arr.length).toFixed(1);
   const avgH = (arr.reduce((s,x)=> s + Number(x.heartrate), 0) / arr.length).toFixed(1);
  const tr = document.createElement('tr');
    tr.innerHTML = `
    <td>${key}</td>
    <td class="cell-center">${avgS}</td>
      <td class="cell-center">${avgD}</td>
 <td class="cell-center">${avgH}</td>
    <td class="cell-center">${arr.length}</td>
   `;
    weeklyBody.appendChild(tr);
      }
    }

    const chart = new Chart(chartCtx, {
 type: 'line',
      data: {
        labels: [],
   datasets: [
    { label: 'Systolic', data: [], borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', tension: 0.25 },
      { label: 'Diastolic', data: [], borderColor: '#8e44ad', backgroundColor: 'rgba(142,68,173,0.1)', tension: 0.25 },
 { label: 'Heart rate', data: [], borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', tension: 0.25 }
   ]
  },
      options: {
    responsive: true,
        maintainAspectRatio: false,
   scales: {
    x: { 
  title: { display: true, text: 'Date' },
       ticks: {
    maxRotation: 45,
     minRotation: 45
        }
      },
      y: { 
   title: { display: true, text: 'Value' }, 
  beginAtZero: false
}
  },
   plugins: {
legend: { position: 'bottom' },
    tooltip: { mode: 'index', intersect: false }
   }
  }
    });

    function renderChart() {
 let sorted = [...entries].sort(sortByDateAsc);
  
      if (chartRangeMode === 'month') {
   const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
  sorted = sorted.filter(e => {
     const date = new Date(e.date);
 return date >= startOfMonth && date <= endOfMonth;
   });
  }

      chart.data.labels = sorted.map(e => e.date);
      chart.data.datasets[0].data = sorted.map(e => Number(e.systolic));
      chart.data.datasets[1].data = sorted.map(e => Number(e.diastolic));
      chart.data.datasets[2].data = sorted.map(e => Number(e.heartrate));
      chart.update();
    }

    form.addEventListener('submit', (e) => {
 e.preventDefault();
      const newEntry = {
    date: dateEl.value,
    systolic: systolicEl.value.trim(),
        diastolic: diastolicEl.value.trim(),
    heartrate: heartrateEl.value.trim(),
    notes: notesEl.value.trim()
 };
  if (!isValidEntry(newEntry)) {
  alert('Please enter valid values within reasonable ranges.');
   return;
      }
  const existingIdx = entries.findIndex(x => x.date === newEntry.date);
      if (existingIdx >= 0) {
   entries[existingIdx] = newEntry;
  } else {
    entries.push(newEntry);
 }
      save();
      renderTable(); renderChart(); renderWeekly();
      form.reset();
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url; a.download = 'health-data.json'; a.click();
URL.revokeObjectURL(url);
    });

    importFile.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
 if (!file) return;
  try {
    const text = await file.text();
  const data = JSON.parse(text);
   if (!Array.isArray(data)) throw new Error('Expected an array of entries.');
    const normalized = [];
   for (const item of data) {
    const e = {
   date: String(item.date ?? '').slice(0, 10),
   systolic: String(item.systolic ?? '').trim(),
        diastolic: String(item.diastolic ?? '').trim(),
   heartrate: String(item.heartrate ?? '').trim(),
   notes: String(item.notes ?? '').trim()
    };
     if (!isValidEntry(e)) throw new Error('Invalid entry found in file.');
      normalized.push(e);
    }
  entries = normalized;
  save();
    renderTable(); renderChart(); renderWeekly();
        importFile.value = '';
  alert('Import successful. Data replaced.');
      } catch (err) {
  alert('Import failed: ' + (err?.message || 'Unknown error'));
      }
    });

    clearBtn.addEventListener('click', () => {
  if (confirm('This will delete all locally stored entries. Continue?')) {
   entries = [];
    save();
    renderTable(); renderChart(); renderWeekly();
      }
    });

    chartRangeInputs.forEach(input => {
input.addEventListener('change', (e) => {
    chartRangeMode = e.target.value;
        renderChart();
 });
});

    prevWeekBtn.addEventListener('click', () => {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      renderTable();
  renderChart();
    });

    nextWeekBtn.addEventListener('click', () => {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  renderTable();
      renderChart();
    });

    renderTable();
    renderChart();
    renderWeekly();
  </script>
</body>
</html>
