@using jsnover.net.blazor.Models
@using jsnover.net.blazor.GameLogic
@inject jsnover.net.blazor.Infrastructure.Services.CardService cardService
@inject IJSRuntime JS

<div class="rounded shadow-border p-5 GameBoard">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-primary me-3" @onclick="RestartGame">Restart</button>
        <h3 class="mb-0 me-3">Solitaire</h3>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" @bind="infiniteDraw" id="drawMode">
            <label class="form-check-label text-white" for="drawMode">Infinite Draw</label>
        </div>
    </div>
    @if (loading)
    {
        <div class="text-center"><span>Loading cards...</span></div>
    }
    else if (gameState != null)
    {
        <div class="row mb-4">
            <div class="col-auto">
                <div class="stock-area me-2">
                    <button class="btn p-0" @onclick="DrawFromStock" disabled="@(gameState.Stock.Count == 0 && !CanRedrawStock)">
                        @if (gameState.Stock.Any())
                        {
                            <div class="card-outline" style="width:75px;height:105px;">
                                <img src="@gameState.Stock[0].back" width="75" alt="Card Back" />
                            </div>
                        }
                        else
                        {
                            <div class="card-outline empty-stack" style="width:75px;height:105px;"></div>
                        }
                    </button>
                    <small class="text-white d-block text-center mt-1">@gameState.Stock.Count cards</small>
                </div>
            </div>
            <div class="col-auto">
                <div class="discard-area mx-2 card-outline" style="width:75px;height:105px;">
                    @if (gameState.Waste.Any())
                    {
                        var card = gameState.Waste.Last();
                        <img src="@card.image" width="75" class="waste-card" draggable="true" data-cardid="waste-0" />
                    }
                    else
                    {
                        <div class="empty-stack" style="width:75px;height:105px;"></div>
                    }
                </div>
            </div>
            <div class="col">
                <div class="d-flex justify-content-end">
                @for (int i = 0; i < 4; i++)
                {
                    <div class="foundation-dropzone mx-1" style="width:75px;height:105px;"
                         data-foundationindex="@i">
                        @if (gameState.Foundations[i].Any())
                        {
                            var card = gameState.Foundations[i].Last();
                            <div class="card-outline" style="width:75px;height:105px;">
                                <img src="@card.image" width="75" />
                            </div>
                        }
                        else
                        {
                            <div class="card-outline empty-stack" style="width:75px;height:105px;"></div>
                        }
                    </div>
                }
                </div>
            </div>
        </div>
        <div class="tableau-area">
            <div class="row g-2">
                @for (int col = 0; col < 7; col++)
                {
                    <div class="col" style="min-height:150px;position:relative;"
                         data-colindex="@col">
                        <div class="tableau-dropzone" data-colindex="@col" style="position:absolute;top:0;left:0;right:0;bottom:0;">
                            @if (!gameState.Tableau[col].Any())
                            {
                                <div class="empty-stack card-outline" style="width:75px;height:105px;"></div>
                            }
                            @for (int i = 0; i < gameState.Tableau[col].Count; i++)
                            {
                                var card = gameState.Tableau[col][i];
                                <img src="@card.image" width="75" class="tableau-card" draggable="true" data-cardid="col-@col-@i"
                                     style="position:absolute;top:@(i*30)px;z-index:@i;" />
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @if (gameState.IsWin())
        {
            <div class="alert alert-success mt-3">You win!</div>
        }
    }
</div>

@code {
    private SolitaireGameState gameState;
    private bool loading = true;
    private bool infiniteDraw = true; // Default to infinite draw mode
    private DotNetObjectReference<SolitaireBoard> objRef;
    
    private bool CanRedrawStock => infiniteDraw && gameState?.Stock.Count == 0 && gameState?.Waste.Any() == true;

    private void DrawFromStock()
    {
        if (gameState.Stock.Count == 0 && infiniteDraw && gameState.Waste.Any())
        {
            // Move all cards from waste back to stock
            gameState.Stock.AddRange(gameState.Waste);
            gameState.Waste.Clear();
            // Shuffle the stock
            Shuffle(gameState.Stock);
        }
        
        gameState.DrawFromStock();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await StartNewGame();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("enableDragDrop", objRef);
        }
        else if (gameState != null)
        {
            // Re-enable drag and drop after state changes
            await JS.InvokeVoidAsync("enableDragDrop", objRef);
        }
    }

    private async Task StartNewGame()
    {
        loading = true;
        StateHasChanged();
        await cardService.GetDeck();
        var cardDraw = await cardService.DrawAllCards();
        var deck = cardDraw.cards.ToList();
        gameState = new SolitaireGameState(deck);
        loading = false;
        StateHasChanged();
    }

    private void RestartGame()
    {
        gameState.Restart();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnCardDrop(string cardId, string targetType, int targetIndex)
    {
        // cardId format: col-<fromCol>-<cardIndex> or waste-0
        await JS.InvokeVoidAsync("console.log", $"C# OnCardDrop called with cardId: {cardId}, targetType: {targetType}, targetIndex: {targetIndex}");
        
        if (cardId.StartsWith("col-"))
        {
            var parts = cardId.Split('-');
            int fromCol = int.Parse(parts[1]);
            int cardIndex = int.Parse(parts[2]);
            if (targetType == "tableau")
            {
                await JS.InvokeVoidAsync("console.log", $"Moving from tableau {fromCol} index {cardIndex} to tableau {targetIndex}");
                bool success = gameState.MoveTableauToTableau(fromCol, cardIndex, targetIndex);
                if (!success)
                {
                    await JS.InvokeVoidAsync("console.log", "Move validation failed - invalid tableau move");
                    return;
                }
            }
            else if (targetType == "foundation")
            {
                await JS.InvokeVoidAsync("console.log", $"Moving from tableau {fromCol} to foundation {targetIndex}");
                bool success = gameState.MoveTableauToFoundation(fromCol, targetIndex);
                await JS.InvokeVoidAsync("console.log", $"Move to foundation {(success ? "succeeded" : "failed")}");
                if (!success)
                {
                    await JS.InvokeVoidAsync("console.log", "Move validation failed - card cannot be moved to foundation");
                    return; // Don't call StateHasChanged if move failed
                }
            }
        }
        else if (cardId.StartsWith("waste-"))
        {
            if (targetType == "tableau")
            {
                await JS.InvokeVoidAsync("console.log", "Moving from waste to tableau");
                bool success = gameState.MoveWasteToTableau(targetIndex);
                if (!success) return;
            }
            else if (targetType == "foundation")
            {
                await JS.InvokeVoidAsync("console.log", "Moving from waste to foundation");
                bool success = gameState.MoveWasteToFoundation(targetIndex);
                if (!success) return;
            }
        }
        
        await JS.InvokeVoidAsync("console.log", "Calling StateHasChanged");
        StateHasChanged();
    }

    private void Shuffle<T>(List<T> list)
    {
        var rng = new Random();
        int n = list.Count;
        while (n > 1)
        {
            n--;
            int k = rng.Next(n + 1);
            T value = list[k];
            list[k] = list[n];
            list[n] = value;
        }
    }
}